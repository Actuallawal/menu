<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="icon" type="image/png" sizes="16x16" href="https://i.ibb.co/3Jh3Wzb/Artboard-1-copy-2.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #0c0f10;
      --card: #161b1e;
      --text: #e6eef3;
      --muted: #9aa6ad;
      --accent: #f37100;
      --border: rgba(255,255,255,0.08);
      --overlay: rgba(0, 0, 0, 0.6);
      --transition: all 0.22s cubic-bezier(.4,0,.2,1);
      --sidebar-width: 260px;
      --topbar-height: 70px;
      --list-row-height: 96px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
    }
    /* Ensure mobile drawer is properly positioned and visible */
    #mobileDrawer {
      width: var(--sidebar-width);
      height: calc(100vh - var(--topbar-height));
      position: fixed;
      top: var(--topbar-height);
      left: 0;
      z-index: 1000;
      background: var(--card);
      border-right: 1px solid var(--border);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 4px 0 20px rgba(0,0,0,0.5);
    }
    .drawer-hidden {
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .drawer-visible {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    /* Top bar */
    .top-bar{
      height:var(--topbar-height);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      position:sticky; top:0; z-index:60;
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo .logo-icon{font-size:20px}
    .top-actions{display:flex;align-items:center;gap:10px}
    .top-actions > * { background:var(--card); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; transition:var(--transition) }
    .top-actions button:hover{ transform:translateY(-2px) }
    /* Layout */
    .layout{ display:flex; min-height:calc(100vh - var(--topbar-height)); }
    /* Sidebar (desktop visible) */
    .sidebar{
      width:var(--sidebar-width);
      min-width:var(--sidebar-width);
      background:var(--card);
      border-right:1px solid var(--border);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      transition: transform 0.28s ease;
    }
    .sidebar .nav-item{ display:flex; gap:10px; align-items:center; padding:10px; border-radius:10px; cursor:pointer; color:var(--muted) }
    .sidebar .nav-item.active{ background:rgba(243,113,0,0.08); color:var(--accent); font-weight:700 }
    .sidebar .nav-item:hover{ color:var(--text) }
    /* Main content */
    .main {
      flex:1;
      padding:18px;
      overflow:auto;
      min-height: calc(100vh - var(--topbar-height));
    }
    /* Stats area */
    .stats {
      display:flex;
      gap:12px;
      margin-bottom:14px;
      align-items:center;
      flex-wrap:wrap;
    }
    .stat-card {
      background:linear-gradient(180deg, rgba(255,255,255,0.012), transparent);
      border:1px solid var(--border);
      padding:10px 14px;
      border-radius:10px;
      min-width:120px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .export-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.date-range {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--card);
  padding: 6px 10px;
  border-radius: 12px;
  border: 1px solid var(--border);
}

.date-input {
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 14px;
  padding: 4px 0;
  min-width: 100px;
}

.date-separator {
  color: var(--muted);
  font-size: 16px;
  font-weight: bold;
}

.export-btn {
  padding: 8px 16px;
  font-size: 14px;
}

/* Mobile optimization */
@media (max-width: 768px) {
  .export-controls {
    gap: 8px;
  }
  
  .date-range {
    padding: 4px 8px;
    gap: 6px;
  }
  
  .date-input {
    font-size: 13px;
    min-width: 80px;
    padding: 2px 0;
  }
  
  .date-separator {
    font-size: 14px;
  }
  
  .export-btn {
    padding: 6px 12px;
    font-size: 13px;
  }
}
    .stat-title{ font-size:12px; color:var(--muted) }
    .stat-number{ font-weight:800; font-size:18px }
    /* Sections */
    .section { display:none; }
    .section.active { display:block; }
    /* Meals list styles (vertical list view) */
    .meals-list {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .meal-row{
      display:flex;
      gap:12px;
      align-items:center;
      background:var(--card);
      border:1px solid var(--border);
      padding:10px;
      border-radius:10px;
      height:var(--list-row-height);
      min-height:var(--list-row-height);
    }
    .meal-row img { width:120px; height:72px; object-fit:cover; border-radius:8px; flex-shrink:0 }
    .meal-body{ flex:1; display:flex; flex-direction:column; gap:6px; min-width:0 }
    .meal-name{ font-weight:700; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .meal-desc{ font-size:13px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .meal-meta{ display:flex; gap:12px; align-items:center; justify-content:space-between }
    .meal-price{ color:var(--accent); font-weight:800 }
    .meal-actions{ display:flex; gap:8px; align-items:center }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer }
    .btn:hover{ transform:translateY(-2px) }
    .btn-primary{ background:linear-gradient(90deg,var(--accent), #ff8a3c); color:white; border:none }
    .btn-danger{ background:transparent; color:#ef4444; border:1px solid rgba(239,68,68,0.15) }
    /* Modal */
    .modal-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:var(--overlay); z-index:200 }
    .modal-overlay.active{ display:flex }
    .modal{ width:min(720px,95%); background:var(--card); border-radius:12px; padding:18px; border:1px solid var(--border) }
    /* Responsive */
    @media (max-width: 900px){
      .sidebar{ display:none }
      .drawer-hidden, .drawer-visible { width:calc(var(--sidebar-width)); box-shadow: 12px 0 30px rgba(0,0,0,0.45) }
      .top-actions { gap:8px }
      .stat-card { min-width:110px; padding:8px }
      .meal-row img{ width:100px; height:64px }
      .meal-row{ height:84px; min-height:84px }
      .main { padding:12px }
      /* Show hamburger on mobile */
      #hamburgerBtn { display: flex !important; }
    }
    @media (max-width:480px){
      .stat-card{ min-width:84px; padding:8px; font-size:13px }
      .logo span{ display:none }
      .logo .logo-icon{ font-size:18px }
      .meal-row img{ width:88px; height:56px }
      .meal-row{ height:80px }
    }
    /* Hide hamburger on desktop */
    @media (min-width: 901px) {
      #hamburgerBtn { display: none !important; }
    }

    @media (max-width: 768px) {
  .date-input {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    padding: 6px 8px;
    border-radius: 8px;
  }
  
  .date-input::-webkit-calendar-picker-indicator {
    filter: invert(1);
    opacity: 0.7;
  }
}
    /* small helpers */
    .muted{ color:var(--muted); font-size:13px }
    .section-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap }
    .search-input{ padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text) }
    .filter-select{ padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text) }
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px var(--overlay);
      z-index: 300;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.success { border-left: 3px solid var(--accent); }
    .toast.error { border-left: 3px solid #ef4444; }
    /* Fixed chart containers */
    .chart-container {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 10px;
      height: 200px;
      display: flex;
      flex-direction: column;
    }
    .chart-container h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .chart-container canvas {
      flex: 1;
      min-height: 0;
    }
    /* Order status styling */
    .order-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .status-pending { 
      background: rgba(234, 179, 8, 0.2); 
      color: #f59e0b; 
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .status-completed { 
      background: rgba(34, 197, 94, 0.2); 
      color: #22c55e; 
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .status-cancelled { 
      background: rgba(239, 68, 68, 0.2); 
      color: #ef4444; 
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    /* Confirm modal */
    .confirm-message {
      margin-bottom: 24px;
      font-size: 16px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="logo">
      <span class="logo-icon">🏪</span>
      <span>Admin</span>
    </div>
    <div class="top-actions">
      <button id="hamburgerBtn" title="Menu" class="btn">☰</button>
      <button id="syncBtn" class="btn" title="Sync">🔄 Sync</button>
      
        <!-- Replace the existing date inputs and export button -->
<div class="export-controls">
  <div class="date-range">
    <input type="date" id="startDate" class="date-input" placeholder="Start">
    <span class="date-separator">→</span>
    <input type="date" id="endDate" class="date-input" placeholder="End">
  </div>
  <button id="exportBtn" class="btn btn-primary export-btn">📥 Export</button>
</div>

      <button id="logoutBtn" class="btn" title="Logout">🔒</button>
    </div>
  </div>
  <div class="layout">
    <!-- Sidebar (desktop) -->
    <nav id="sidebar" class="sidebar" aria-label="Main navigation">
      <div class="nav-item active" data-section="orders">🧾 <span>Orders</span></div>
      <div class="nav-item" data-section="meals">🍔 <span>Meals</span></div>
      <div class="nav-item" data-section="analytics">📊 <span>Analytics</span></div>
      <hr style="border:none;border-top:1px solid var(--border);margin:10px 0" />
      <div style="margin-top:auto">
        <div style="font-size:12px;color:var(--muted)">Signed in as</div>
        <div style="font-weight:700;margin-top:6px">Admin</div>
      </div>
    </nav>
    <!-- Mobile Drawer -->
    <nav id="mobileDrawer" class="sidebar drawer-hidden" aria-hidden="true">
      <div class="nav-item" data-section="orders">🧾 <span>Orders</span></div>
      <div class="nav-item" data-section="meals">🍔 <span>Meals</span></div>
      <div class="nav-item" data-section="analytics">📊 <span>Analytics</span></div>
    </nav>
    <!-- Main content -->
    <main class="main" id="main">
      <!-- Stats -->
      <div class="stats" id="statsArea">
        <div class="stat-card">
          <div class="stat-title">Total Orders</div>
          <div class="stat-number" id="totalOrders">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Revenue</div>
          <div class="stat-number" id="totalRevenue">₦0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Meals</div>
          <div class="stat-number" id="totalMeals">0</div>
        </div>
      </div>
      <!-- Orders section -->
      <section id="ordersSection" class="section active">
        <div class="section-header">
          <h2>Recent Orders</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="orderSearch" class="search-input" placeholder="Search orders..." />
            <select id="orderStatusFilter" class="filter-select">
              <option value="all">All</option>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div id="ordersGrid" style="display:flex;flex-direction:column;gap:10px"></div>
      </section>
      <!-- Meals section (list) -->
      <section id="mealsSection" class="section">
        <div class="section-header">
          <h2>All Meals</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="mealSearch" class="search-input" placeholder="Search meals..." />
            <select id="mealCategoryFilter" class="filter-select">
              <option value="all">All Categories</option>
              <option value="Main Course">Main Course</option>
              <option value="Fast Food">Fast Food</option>
              <option value="Drinks & Beverages">Drinks & Beverages</option>
              <option value="Snacks & Sides">Snacks & Sides</option>
              <option value="Desserts">Desserts</option>
            </select>
            <button id="addMealBtn" class="btn btn-primary">+ Add Meal</button>
          </div>
        </div>
        <div id="mealsList" class="meals-list" aria-live="polite"></div>
      </section>
      <!-- Analytics -->
      <section id="analyticsSection" class="section">
        <div class="section-header">
          <h2>Analytics</h2>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:14px">
          <div class="stat-card"><div class="stat-title">Today's Orders</div><div class="stat-number" id="todayOrders">0</div></div>
          <div class="stat-card"><div class="stat-title">Today's Revenue</div><div class="stat-number" id="todayRevenue">₦0</div></div>
          <div class="stat-card"><div class="stat-title">Avg Order</div><div class="stat-number" id="avgOrder">₦0</div></div>
          <div class="stat-card"><div class="stat-title">Top Meal</div><div class="stat-number" id="topMeal">-</div></div>
        </div>
        <div style="display:grid;gap:14px">
          <div class="chart-container">
            <h3>Orders per Day (14d)</h3>
            <canvas id="ordersChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>Revenue (14d)</h3>
            <canvas id="revenueChart"></canvas>
          </div>
        </div>
      </section>
    </main>
  </div>
  <!-- Add/Edit Meal Modal -->
  <div id="mealModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3 id="mealModalTitle">Add Meal</h3>
        <button id="closeMealModal" class="btn">×</button>
      </div>
      <form id="mealForm">
        <div style="display:flex;flex-direction:column;gap:8px">
          <label>
            <div class="muted">Meal name</div>
            <input id="mealName" class="search-input" required />
          </label>
          <label>
            <div class="muted">Description</div>
            <input id="mealDescription" class="search-input" />
          </label>
          <div style="display:flex;gap:8px">
            <label style="flex:1">
              <div class="muted">Price (₦)</div>
              <input id="mealPrice" type="number" step="0.01" min="0" class="search-input" required />
            </label>
            <label style="width:180px">
              <div class="muted">Category</div>
              <select id="mealCategory" class="filter-select" required>
                <option value="">Select</option>
                <option value="Main Course">Main Course</option>
                <option value="Fast Food">Fast Food</option>
                <option value="Drinks & Beverages">Drinks & Beverages</option>
                <option value="Snacks & Sides">Snacks & Sides</option>
                <option value="Desserts">Desserts</option>
              </select>
            </label>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="mealAvailable" checked /> <span class="muted">Available</span>
            </label>
            <label style="flex:1">
              <div class="muted">Image</div>
              <input id="mealImage" type="file" accept="image/*" />
            </label>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button type="button" id="cancelMealBtn" class="btn">Cancel</button>
            <button type="submit" id="saveMealBtn" class="btn btn-primary">Save Meal</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- Order Details Modal -->
  <div id="orderModal" class="modal-overlay" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>Order Details</h3>
        <button id="closeOrderModal" class="btn">×</button>
      </div>
      <div id="orderDetails"></div>
    </div>
  </div>
  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <h3 id="confirmTitle">Confirm Action</h3>
        <button id="closeConfirmModal" class="btn">×</button>
      </div>
      <div id="confirmMessage" style="margin-bottom:20px;line-height:1.5"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="confirmNo" class="btn">Cancel</button>
        <button id="confirmYes" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>
  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <span id="toastMessage">Notification message</span>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.js"></script>
  <script>
  const SUPABASE_URL = 'https://tbnjvmibyzeqmgnaavpc.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_GfSPdiJgIXfURhNDREfPEw_1uNQvT46';
  const STORAGE_BUCKET = 'meal-images';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  // Check auth on page load
  if (!localStorage.getItem('admin_logged_in')) {
    window.location.href = 'admin.html';
  }
  
  const sidebar = document.getElementById('sidebar');
  const mobileDrawer = document.getElementById('mobileDrawer');
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const navItems = document.querySelectorAll('.sidebar .nav-item, #mobileDrawer .nav-item');
  const sections = document.querySelectorAll('.section');
  const ordersGrid = document.getElementById('ordersGrid');
  const mealsList = document.getElementById('mealsList');
  const addMealBtn = document.getElementById('addMealBtn');
  const mealModal = document.getElementById('mealModal');
  const mealForm = document.getElementById('mealForm');
  const closeMealModal = document.getElementById('closeMealModal');
  const cancelMealBtn = document.getElementById('cancelMealBtn');
  const saveMealBtn = document.getElementById('saveMealBtn');
  const orderModal = document.getElementById('orderModal');
  const closeOrderModal = document.getElementById('closeOrderModal');
  const orderDetails = document.getElementById('orderDetails');
  const mealCategoryFilter = document.getElementById('mealCategoryFilter');
  const mealSearch = document.getElementById('mealSearch');
  const orderSearch = document.getElementById('orderSearch');
  const orderStatusFilter = document.getElementById('orderStatusFilter');
  const syncBtn = document.getElementById('syncBtn');
  const exportBtn = document.getElementById('exportBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  const confirmModal = document.getElementById('confirmModal');
  
  const totalOrdersEl = document.getElementById('totalOrders');
  const totalRevenueEl = document.getElementById('totalRevenue');
  const totalMealsEl = document.getElementById('totalMeals');
  const todayOrdersEl = document.getElementById('todayOrders');
  const todayRevenueEl = document.getElementById('todayRevenue');
  const avgOrderEl = document.getElementById('avgOrder');
  const topMealEl = document.getElementById('topMeal');
  
  let meals = [];
  let orders = [];
  let currentMeal = null;
  let drawerVisible = false;
  let ordersChart = null, revenueChart = null;
  
  function openModal(el) { 
    el.classList.add('active'); 
    el.setAttribute('aria-hidden','false'); 
    document.body.style.overflow='hidden'; 
  }
  
  function closeModal(el) { 
    el.classList.remove('active'); 
    el.setAttribute('aria-hidden','true'); 
    document.body.style.overflow=''; 
  }
  
  function showToast(message, type = 'info') {
    toastMessage.textContent = message;
    toast.className = 'toast ' + type;
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }
  
  function escapeHtml(s=''){ 
    return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'<','>':'>','"':'&quot;',"'":"&#39;"}[c])); 
  }
  
  // FIXED HAMBURGER FUNCTIONALITY - COMPLETE SOLUTION
  function activateSection(name) {
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById(`${name}Section`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.section === name);
    });
    if (window.innerWidth <= 900) {
      toggleDrawer(false);
    }
  }
  
  document.querySelectorAll('#sidebar .nav-item').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const section = item.dataset.section;
      activateSection(section);
    });
  });
  
  document.querySelectorAll('#mobileDrawer .nav-item').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const section = item.dataset.section;
      activateSection(section);
    });
  });
  
  hamburgerBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDrawer();
  });
   
  function toggleDrawer(force) {
    drawerVisible = typeof force === 'boolean' ? force : !drawerVisible;
    if (drawerVisible) {
      mobileDrawer.classList.remove('drawer-hidden');
      mobileDrawer.classList.add('drawer-visible');
      mobileDrawer.setAttribute('aria-hidden', 'false');
    } else {
      mobileDrawer.classList.remove('drawer-visible');
      mobileDrawer.classList.add('drawer-hidden');
      mobileDrawer.setAttribute('aria-hidden', 'true');
    }
  }
  
  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 900 && drawerVisible) {
      const clickedInsideDrawer = mobileDrawer.contains(e.target);
      const clickedHamburger = hamburgerBtn.contains(e.target);
      
      if (!clickedInsideDrawer && !clickedHamburger) {
        toggleDrawer(false);
      }
    }
  });
  
  // Confirm modal functions
  function showConfirm(title, message, callback, confirmText = 'Confirm') {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmYes').textContent = confirmText;
    
    confirmModal.classList.add('active');
    confirmModal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    
    window.confirmCallback = callback;
  }
  
  document.getElementById('closeConfirmModal').addEventListener('click', () => {
    confirmModal.classList.remove('active');
    confirmModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    window.confirmCallback = null;
  });
  
  document.getElementById('confirmYes').addEventListener('click', () => {
    if (window.confirmCallback) {
      window.confirmCallback();
      window.confirmCallback = null;
    }
    confirmModal.classList.remove('active');
    confirmModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  });
  
  document.getElementById('confirmNo').addEventListener('click', () => {
    confirmModal.classList.remove('active');
    confirmModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    window.confirmCallback = null;
  });
  
  confirmModal.addEventListener('click', (e) => {
    if (e.target === confirmModal) {
      confirmModal.classList.remove('active');
      confirmModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      window.confirmCallback = null;
    }
  });
  
  // Data fetching functions
  function getCachedData(key, maxAge = 600000) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed.timestamp) return null;
      if (Date.now() - parsed.timestamp > maxAge) { 
        localStorage.removeItem(key); 
        return null; 
      }
      return parsed.data;
    } catch (e) { 
      localStorage.removeItem(key); 
      return null; 
    }
  }
  
  function setCachedData(key, data) { 
    localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() })); 
  }
  
  async function fetchMeals(useCache = true) {
    try {
      if (useCache) {
        const cached = getCachedData('admin_meals', 300000);
        if (cached) { 
          meals = cached; 
          renderMealsList(); 
          totalMealsEl.textContent = meals.length; 
          return; 
        }
      }
      const { data, error } = await supabase
        .from('meals')
        .select('id,name,description,price,category,image_url,archived,created_at')
        .order('created_at', { ascending: false });
      if (error) throw error;
      meals = (data || []).map(m => ({ 
        ...m, 
        archived: Boolean(m.archived), 
        category: (m.category||'').trim() 
      }));
      setCachedData('admin_meals', meals);
      totalMealsEl.textContent = meals.length;
      renderMealsList();
    } catch (err) {
      console.error('fetchMeals error', err);
      showToast('Failed to load meals', 'error');
    }
  }
  
  async function fetchOrders() {
    try {
      const { data, error } = await supabase.from('orders').select('*').order('created_at', { ascending: false });
      if (error) throw error;
      orders = data || [];
      setCachedData('admin_orders', orders);
      updateStats();
      renderOrders();
    } catch (err) {
      console.error('fetchOrders', err);
      showToast('Failed to load orders', 'error');
    }
  }
  
  function renderMealsList() {
    const q = mealSearch.value.trim().toLowerCase();
    const cat = mealCategoryFilter.value;
    const filtered = meals.filter(m => {
      if (cat !== 'all' && m.category.toLowerCase() !== cat.toLowerCase()) return false;
      if (!q) return true;
      return (m.name || '').toLowerCase().includes(q) || (m.description||'').toLowerCase().includes(q);
    });
    if (!filtered.length) {
      mealsList.innerHTML = `<div class="muted">No meals found</div>`;
      return;
    }
    mealsList.innerHTML = filtered.map(meal => {
      const unavailableBadge = meal.archived ? `<div style="color:#fff;background:rgba(239,68,68,0.85);padding:4px 8px;border-radius:12px;font-size:12px">Unavailable</div>` : '';
      return `
        <div class="meal-row" data-id="${meal.id}">
          <img src="${meal.image_url || 'https://placehold.co/600x400?text=Meal'}" alt="${escapeHtml(meal.name)}">
          <div class="meal-body">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
              <div class="meal-name">${escapeHtml(meal.name)}</div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="meal-price">₦${Number(meal.price||0).toLocaleString()}</div>
                ${unavailableBadge}
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
              <div class="meal-desc">${escapeHtml(meal.description||'')}</div>
              <div class="meal-actions">
                <button class="btn" data-action="edit" data-id="${meal.id}">Edit</button>
                <button class="btn btn-danger" data-action="delete" data-id="${meal.id}">Delete</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    mealsList.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (action === 'edit') openEditMeal(id);
        if (action === 'delete') confirmDeleteMeal(id);
      });
    });
  }
  
  function renderOrders() {
    const q = orderSearch.value.trim().toLowerCase();
    const status = orderStatusFilter.value;
    const filtered = orders.filter(o=>{
      if (status !== 'all' && o.status !== status) return false;
      if (!q) return true;
      return (o.customer_name||'').toLowerCase().includes(q) || (o.id||'').toLowerCase().includes(q);
    });
    if (!filtered.length) {
      ordersGrid.innerHTML = `<div class="muted">No orders found</div>`; 
      return;
    }
    ordersGrid.innerHTML = filtered.map(o=>{
      const statusClass = `status-${o.status}`;
      
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--card);border:1px solid var(--border)">
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(o.customer_name || 'Anonymous')}</div>
            <div class="muted">${new Date(o.created_at).toLocaleString()} • ${o.order_type || ''}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <div style="font-weight:800">₦${Number(o.total_amount||0).toLocaleString()}</div>
            <div class="order-status ${statusClass}">${o.status}</div>
            <div style="display:flex;gap:8px; margin-top: 8px;">
              <button class="btn" data-action="view" data-id="${o.id}">View</button>
              ${o.status === 'pending' ? `<button class="btn btn-primary" data-action="complete" data-id="${o.id}">Complete</button>` : ''}
              ${o.status === 'pending' ? `<button class="btn btn-danger" data-action="cancel" data-id="${o.id}">Cancel</button>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    ordersGrid.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (action === 'view') viewOrderDetails(id);
        if (action === 'complete') updateOrderStatus(id, 'completed');
        if (action === 'cancel') updateOrderStatus(id, 'cancelled');
      });
    });
  }
  
  function openAddMeal() {
    currentMeal = null;
    mealForm.reset();
    document.getElementById('mealAvailable').checked = true;
    document.getElementById('mealModalTitle').textContent = 'Add Meal';
    openModal(mealModal);
  }
  
  async function openEditMeal(id) {
    const meal = meals.find(m => String(m.id) === String(id));
    if (!meal) return showToast('Meal not found', 'error');
    currentMeal = id;
    document.getElementById('mealModalTitle').textContent = 'Edit Meal';
    document.getElementById('mealName').value = meal.name;
    document.getElementById('mealDescription').value = meal.description || '';
    document.getElementById('mealPrice').value = meal.price;
    document.getElementById('mealCategory').value = meal.category || '';
    document.getElementById('mealAvailable').checked = !meal.archived;
    openModal(mealModal);
  }
  
  async function uploadImageFile(file) {
    if (!file) return null;
    try {
      const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
      const fileName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
      const { data, error } = await supabase.storage.from(STORAGE_BUCKET).upload(fileName, file, { cacheControl: '3600', upsert: false });
      if (error) throw error;
      const { data: urlData } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(fileName);
      return urlData.publicUrl;
    } catch (err) {
      console.error('uploadImageFile', err);
      throw err;
    }
  }
  
  mealForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    saveMealBtn.disabled = true;
    saveMealBtn.textContent = 'Saving...';
    try {
      const name = document.getElementById('mealName').value.trim();
      const description = document.getElementById('mealDescription').value.trim();
      const price = parseFloat(document.getElementById('mealPrice').value) || 0;
      const category = document.getElementById('mealCategory').value;
      const available = document.getElementById('mealAvailable').checked;
      const fileInput = document.getElementById('mealImage');
      let imageUrl = '';
      if (!name) { showToast('Name required'); return; }
      if (!category) { showToast('Select category'); return; }
      if (fileInput.files && fileInput.files[0]) {
        try {
          imageUrl = await uploadImageFile(fileInput.files[0]);
        } catch (imgErr) {
          console.warn('Image upload failed, continuing without image', imgErr);
        }
      }
      if (currentMeal) {
        const updates = { name, description, price, category, archived: !available };
        if (imageUrl) updates.image_url = imageUrl;
        const { error } = await supabase.from('meals').update(updates).eq('id', currentMeal);
        if (error) throw error;
        showToast('Meal updated', 'success');
      } else {
        const { error } = await supabase.from('meals').insert([{ name, description, price, category, image_url: imageUrl, archived: !available }]);
        if (error) throw error;
        showToast('Meal added', 'success');
      }
      localStorage.removeItem('admin_meals');
      await fetchMeals(false);
      closeModal(mealModal);
    } catch (err) {
      console.error('save meal error', err);
      showToast('Failed to save meal', 'error');
    } finally {
      saveMealBtn.disabled = false;
      saveMealBtn.textContent = 'Save Meal';
    }
  });
  
  cancelMealBtn.addEventListener('click', () => closeModal(mealModal));
  closeMealModal.addEventListener('click', () => closeModal(mealModal));
  addMealBtn.addEventListener('click', openAddMeal);
  
  function confirmDeleteMeal(id) {
    showConfirm(
      'Delete Meal',
      'Are you sure you want to permanently delete this meal? This action cannot be undone.',
      () => deleteMeal(id),
      'Delete'
    );
  }
  
  async function deleteMeal(id) {
    try {
      const { error } = await supabase.from('meals').delete().eq('id', id);
      if (error) throw error;
      showToast('Meal deleted', 'success');
      localStorage.removeItem('admin_meals');
      await fetchMeals(false);
    } catch (err) {
      console.error('deleteMeal', err);
      showToast('Failed to delete meal', 'error');
    }
  }
  
  function viewOrderDetails(id) {
    const order = orders.find(o => String(o.id) === String(id));
    if (!order) return showToast('Order not found', 'error');
    let items = order.items;
    if (typeof items === 'string') {
      try { items = JSON.parse(items); } catch (e) { items = []; }
    }
    orderDetails.innerHTML = `
      <div><strong>Order ID:</strong> ${order.id}</div>
      <div><strong>Customer:</strong> ${escapeHtml(order.customer_name || 'N/A')}</div>
      <div><strong>Type:</strong> ${escapeHtml(order.order_type || '')}</div>
      <div><strong>Payment:</strong> ${order.payment_method === 'transfer' ? 'Bank Transfer' : 'Cash/POS'}</div>
      <div style="margin-top:8px"><strong>Items:</strong></div>
      ${Array.isArray(items) && items.length ? '<ul>' + items.map(it => `<li>${escapeHtml(it.name)} x${it.quantity} - ₦${(it.unitPrice||0).toLocaleString()}</li>`).join('') + '</ul>' : '<div class="muted">No items</div>'}
      <div style="margin-top:8px"><strong>Total:</strong> ₦${Number(order.total_amount||0).toLocaleString()}</div>
    `;
    openModal(orderModal);
  }
  
  closeOrderModal.addEventListener('click', ()=>closeModal(orderModal));
  orderModal.addEventListener('click', (e)=>{ if (e.target === orderModal) closeModal(orderModal); });
  
  async function updateOrderStatus(orderId, status) {
    try {
      const { error } = await supabase.from('orders').update({ status }).eq('id', orderId);
      if (error) throw error;
      const o = orders.find(x => String(x.id) === String(orderId));
      if (o) o.status = status;
      renderOrders();
      updateStats();
      showToast(`Order marked as ${status}`, 'success');
    } catch (err) {
      console.error('updateOrderStatus', err);
      showToast('Failed to update order', 'error');
    }
  }
  
  function updateStats() {
    const totalOrders = orders.length;
    const totalRevenue = orders.reduce((s,o)=> s + (o.total_amount||0), 0);
    const today = new Date(); today.setHours(0,0,0,0);
    const todayOrders = orders.filter(o => {
      const d = new Date(o.created_at); d.setHours(0,0,0,0); return d.getTime() === today.getTime();
    });
    const todayRevenue = todayOrders.reduce((s,o)=> s + (o.total_amount||0), 0);
    const avgOrder = totalOrders ? Math.round(totalRevenue/totalOrders) : 0;
    const counts = {};
    orders.forEach(o=>{
      let items = o.items;
      if (typeof items === 'string') {
        try{ items = JSON.parse(items); } catch(e){ items = []; }
      }
      if (Array.isArray(items)) items.forEach(it => { counts[it.name] = (counts[it.name]||0) + (it.quantity||0) });
    });
    const topMeal = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
    totalOrdersEl.textContent = totalOrders;
    totalRevenueEl.textContent = `₦${totalRevenue.toLocaleString()}`;
    totalMealsEl.textContent = meals.length;
    todayOrdersEl.textContent = todayOrders.length;
    todayRevenueEl.textContent = `₦${todayRevenue.toLocaleString()}`;
    avgOrderEl.textContent = `₦${avgOrder.toLocaleString()}`;
    topMealEl.textContent = topMeal;
    renderCharts();
  }
  
  function renderCharts() {
    const last14 = Array.from({length:14},(_,i)=> {
      const d = new Date(); d.setDate(d.getDate() - (13 - i)); d.setHours(0,0,0,0); return d;
    });
    const labels = last14.map(d => d.toLocaleDateString());
    const orderCounts = last14.map(d => orders.filter(o => (new Date(o.created_at)).toDateString() === d.toDateString()).length);
    const revenueData = last14.map(d => orders.filter(o => (new Date(o.created_at)).toDateString() === d.toDateString()).reduce((s,o)=> s + (o.total_amount||0), 0));
    
    const ordersCtx = document.getElementById('ordersChart').getContext('2d');
    if (ordersChart) ordersChart.destroy();
    ordersChart = new Chart(ordersCtx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Orders', data: orderCounts, borderColor: '#f37100', tension:0.3, fill: false }] },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: 'var(--muted)' }, grid: { color: 'var(--border)' } },
          x: { ticks: { color: 'var(--muted)' }, grid: { color: 'var(--border)' } }
        }
      }
    });
    
    const revCtx = document.getElementById('revenueChart').getContext('2d');
    if (revenueChart) revenueChart.destroy();
    revenueChart = new Chart(revCtx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Revenue', data: revenueData, backgroundColor: 'rgba(243,113,0,0.6)', borderColor: '#f37100', borderWidth: 1 }] },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: 'var(--muted)', callback: v => '₦' + v.toLocaleString() }, grid: { color: 'var(--border)' } },
          x: { ticks: { color: 'var(--muted)' }, grid: { color: 'var(--border)' } }
        }
      }
    });
  }
  
  function setupRealtime() {
    supabase
      .channel('admin-meals')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'meals' }, payload => {
        localStorage.removeItem('admin_meals');
        fetchMeals(false);
      })
      .subscribe();
    supabase
      .channel('admin-orders')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
        localStorage.removeItem('admin_orders');
        fetchOrders();
      })
      .subscribe();
  }
  
  syncBtn.addEventListener('click', async ()=>{
    await Promise.all([fetchMeals(false), fetchOrders()]);
    showToast('Data synced successfully', 'success');
  });
  
  exportBtn.addEventListener('click', () => {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  // Get ALL orders (completed + cancelled) within date range
  let filteredOrders = orders.filter(order => 
    order.status === 'completed' || order.status === 'cancelled'
  );
  
  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);
    
    filteredOrders = filteredOrders.filter(order => {
      const orderDate = new Date(order.created_at);
      return orderDate >= start && orderDate <= end;
    });
  } else if (startDate || endDate) {
    showToast('Please select both start and end dates', 'warning');
    return;
  }
  
  if (filteredOrders.length === 0) {
    showToast('No completed or cancelled orders found in selected date range', 'warning');
    return;
  }
  
  try {
    // Create worksheet data with all order details
    const ws_data = [
      ['ADMIN ORDERS REPORT'],
      [`Exported: ${new Date().toLocaleString()}`],
      startDate && endDate ? [`Date Range: ${startDate} to ${endDate}`] : ['All Time'],
      [],
      ['Order ID', 'Customer Name', 'Order Type', 'Payment Method', 'Total Amount (₦)', 'Status', 'Order Date']
    ];
    
    // Add all filtered orders (completed + cancelled)
    filteredOrders.forEach(order => {
      ws_data.push([
        order.id,
        order.customer_name || 'N/A',
        order.order_type,
        order.payment_method === 'transfer' ? 'Bank Transfer' : 'Cash/POS',
        order.total_amount,
        order.status.charAt(0).toUpperCase() + order.status.slice(1), // Capitalize status
        new Date(order.created_at).toLocaleDateString('en-GB')
      ]);
    });
    
    // Calculate totals (ONLY for completed orders)
    const completedOrders = filteredOrders.filter(o => o.status === 'completed');
    const totalCompletedOrders = completedOrders.length;
    const totalCompletedRevenue = completedOrders.reduce((sum, order) => sum + (order.total_amount || 0), 0);
    
    // Add summary section
    ws_data.push(
      [],
      ['SUMMARY'],
      ['Total Orders (Completed + Cancelled)', filteredOrders.length],
      ['Completed Orders Only', totalCompletedOrders],
      ['Total Revenue (Completed Only)', totalCompletedRevenue]
    );
    
    // Create and export workbook
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Orders Report');
    
    // Format currency columns
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 4; R <= range.e.r; R++) {
      const cell = ws[XLSX.utils.encode_cell({r: R, c: 4})]; // Total Amount column
      if (cell && typeof cell.v === 'number') {
        cell.z = '₦#,##0.00';
      }
    }
    
    // Auto-size columns
    const colWidths = [];
    ws_data[4].forEach((header, i) => {
      colWidths.push({ wch: Math.max(header.toString().length + 2, 15) });
    });
    ws['!cols'] = colWidths;
    
    // Generate filename with dates
    const filename = startDate && endDate 
      ? `orders-report-${startDate}-to-${endDate}.xlsx`
      : `orders-report-${new Date().toISOString().split('T')[0]}.xlsx`;
    
    XLSX.writeFile(wb, filename);
    showToast('Orders exported successfully!', 'success');
    
  } catch (err) {
    console.error('Export error:', err);
    showToast('Export failed: ' + (err.message || 'Unknown error'), 'error');
  }
});

function isValidDateRange(startDate, endDate) {
  if (!startDate || !endDate) return false;
  const start = new Date(startDate);
  const end = new Date(endDate);
  return start <= end;
}
  
  logoutBtn.addEventListener('click', () => {
    showConfirm(
      'Logout',
      'Are you sure you want to logout?',
      () => {
        localStorage.removeItem('admin_logged_in');
        localStorage.removeItem('admin_user');
        window.location.href = 'admin.html';
      },
      'Logout'
    );
  });
  
  mealSearch.addEventListener('input', renderMealsList);
  mealCategoryFilter.addEventListener('change', renderMealsList);
  orderSearch.addEventListener('input', renderOrders);
  orderStatusFilter.addEventListener('change', renderOrders);
  
  async function init() {
    await Promise.all([fetchMeals(), fetchOrders()]);
    setupRealtime();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  </script>
</body>
</html>
